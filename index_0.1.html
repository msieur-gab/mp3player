<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Local PWA Player</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes"> 
<!-- This is required for the status bar style tag to work -->
<meta name="apple-mobile-web-app-status-bar-style" content="black">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #scroller-container { position: relative; height: 100%; overflow-y: auto; contain: strict; }
        #scroller-content { position: absolute; top: 0; left: 0; width: 100%; }
        #console-log { font-family: monospace; font-size: 11px; line-height: 1.4; }
    </style>
</head>
<body class="bg-black text-white h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="p-4 bg-gray-900 border-b border-gray-800 flex justify-between items-center shrink-0 z-20">
        <div class="flex items-center gap-2">
            <div class="bg-violet-600 p-1.5 rounded-lg"><i class="ph ph-music-notes text-white"></i></div>
            <div>
                <h1 class="font-bold text-sm leading-tight text-gray-100">Local Stream</h1>
                <p class="text-[10px] text-gray-500" id="status">Ready</p>
            </div>
        </div>
        <div class="flex gap-2">
            <!-- Install Button (Hidden by default) -->
            <button id="installBtn" class="hidden bg-gray-800 text-blue-400 border border-blue-900/50 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1">
                <i class="ph ph-download-simple"></i> Install
            </button>
            <button id="scanBtn" class="bg-violet-600 active:bg-violet-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1">
                <i class="ph ph-folder-notch-open"></i> Scan SD
            </button>
        </div>
    </header>

    <!-- Restore Banner -->
    <div id="perm-banner" class="hidden bg-blue-600 text-white p-3 text-center cursor-pointer hover:bg-blue-700 shrink-0 z-30 font-medium text-xs">
        <i class="ph ph-key"></i> Tap to restore SD Card Access
    </div>

    <!-- Main View -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <div class="flex-1 relative bg-black border-b border-gray-800" id="scroller-wrapper">
            <div id="scroller-container">
                <div id="scroller-phantom"></div>
                <div id="scroller-content"></div>
            </div>
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 pointer-events-none">
                <i class="ph ph-music-notes-simple text-6xl mb-4 opacity-20"></i>
                <p class="text-sm opacity-50">No music loaded</p>
            </div>
        </div>
        <!-- Collapsible Logs -->
        <div class="bg-gray-950 border-t border-gray-800 flex flex-col shrink-0 transition-all duration-300 h-8 overflow-hidden" id="log-panel">
            <div class="px-3 py-2 bg-gray-900 text-[10px] text-gray-500 flex justify-between cursor-pointer hover:bg-gray-800" onclick="toggleLogs()">
                <span>SYSTEM LOGS (Tap to expand)</span><span onclick="event.stopPropagation(); document.getElementById('console-log').innerHTML=''">CLEAR</span>
            </div>
            <div id="console-log" class="flex-1 overflow-y-auto p-2 text-green-400 break-all h-32"></div>
        </div>
    </main>

    <!-- Player Footer -->
    <footer class="bg-gray-900 border-t border-gray-800 h-20 shrink-0 flex flex-col justify-center px-4 z-40 pb-safe">
        <div class="flex items-center justify-between gap-4 mb-2">
            
            <!-- Art & Info -->
            <div class="flex items-center gap-3 overflow-hidden flex-1">
                <div class="w-10 h-10 bg-gray-800 rounded-md flex-shrink-0 relative overflow-hidden border border-gray-700">
                    <img id="p-art" class="w-full h-full object-cover hidden">
                    <div id="p-art-default" class="absolute inset-0 flex items-center justify-center text-gray-600">
                        <i class="ph ph-music-note text-xl"></i>
                    </div>
                </div>
                <div class="truncate">
                    <h3 id="p-title" class="font-bold text-sm text-gray-100 truncate">Not Playing</h3>
                    <p id="p-artist" class="text-xs text-gray-500 truncate">Select a track</p>
                </div>
            </div>

            <!-- Controls -->
            <button id="playBtn" class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center text-lg shadow-lg active:scale-95 transition">
                <i id="playIcon" class="ph ph-play-fill ml-0.5"></i>
            </button>
        </div>
        
        <!-- Seek Bar -->
        <input type="range" id="seek" value="0" max="100" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-violet-500">
    </footer>

    <audio id="audio"></audio>

    <script>
        // 1. PWA INSTALL LOGIC
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.classList.remove('hidden');
            log('Install prompt captured');
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            log(`User install choice: ${outcome}`);
            deferredPrompt = null;
            installBtn.classList.add('hidden');
        });

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(() => {});

        // 2. UTILS
        function log(msg, type = 'info') {
            const el = document.getElementById('console-log');
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            if (type === 'error') div.className = "text-red-400 font-bold";
            el.appendChild(div);
        }
        function toggleLogs() {
            const p = document.getElementById('log-panel');
            p.classList.toggle('h-8');
            p.classList.toggle('h-40');
        }

        // 3. DB & CONFIG
        const ROW_HEIGHT = 56;
        const BATCH_SIZE = 500;
        const db = new Dexie("MegaMusicPWA");
        db.version(1).stores({ tracks: '++id, title, path' });

        let allTracks = [], dirHandleRoot = null, isPlaying = false, currentTrackIdx = -1;
        const audio = document.getElementById('audio');
        
        // 4. SCAN
        document.getElementById('scanBtn').onclick = async () => {
            if (!window.showDirectoryPicker) return log("API Unsupported.", 'error');
            try {
                dirHandleRoot = await window.showDirectoryPicker({ id: 'music_root', mode: 'read' });
                await db.tracks.put({ id: 'root_handle', handle: dirHandleRoot });
                
                await db.tracks.where('id').notEqual('root_handle').delete();
                allTracks = []; renderList();

                let buffer = [], count = 0;
                async function traverse(handle, path) {
                    for await (const entry of handle.values()) {
                        if (entry.kind === 'file' && /\.(mp3|m4a|flac|wav)$/i.test(entry.name)) {
                            buffer.push({ title: entry.name, handle: entry, path: path + "/" + entry.name });
                            if (buffer.length >= BATCH_SIZE) {
                                await db.tracks.bulkAdd(buffer);
                                count += buffer.length;
                                document.getElementById('status').innerText = `Found ${count}`;
                                buffer = [];
                            }
                        } else if (entry.kind === 'directory') await traverse(entry, path + "/" + entry.name);
                    }
                }
                log("Scanning...");
                await traverse(dirHandleRoot, "");
                if (buffer.length > 0) await db.tracks.bulkAdd(buffer);
                
                log("Complete.");
                loadLibrary();
            } catch (err) { log(err.message, 'error'); }
        };

        // 5. LOAD LIBRARY
        async function loadLibrary() {
            try {
                const root = await db.tracks.get('root_handle');
                if (root) {
                    dirHandleRoot = root.handle;
                    const perm = await dirHandleRoot.queryPermission({ mode: 'read' });
                    if (perm !== 'granted') document.getElementById('perm-banner').classList.remove('hidden');
                }
                allTracks = await db.tracks.where('id').notEqual('root_handle').toArray();
                document.getElementById('status').innerText = `${allTracks.length} tracks`;
                if(allTracks.length > 0) {
                    document.getElementById('empty-state').classList.add('hidden');
                    initScroller();
                }
            } catch(e) { log(e.message, 'error'); }
        }

        document.getElementById('perm-banner').onclick = async () => {
            if(!dirHandleRoot) return;
            if ((await dirHandleRoot.requestPermission({ mode: 'read' })) === 'granted') {
                document.getElementById('perm-banner').classList.add('hidden');
            }
        };

        // 6. VIRTUAL SCROLLER
        const container = document.getElementById('scroller-container');
        const content = document.getElementById('scroller-content');
        const phantom = document.getElementById('scroller-phantom');

        function initScroller() {
            phantom.style.height = `${allTracks.length * ROW_HEIGHT}px`;
            container.onscroll = renderList;
            renderList();
        }

        function renderList() {
            const scrollTop = container.scrollTop;
            const start = Math.floor(scrollTop / ROW_HEIGHT);
            const end = Math.min(allTracks.length - 1, start + Math.ceil(container.clientHeight / ROW_HEIGHT) + 5);
            let html = '';
            for (let i = start; i <= end; i++) {
                const t = allTracks[i];
                html += `<div class="absolute w-full px-4 flex items-center justify-between border-b border-gray-800 hover:bg-gray-800 cursor-pointer ${i===currentTrackIdx ? 'text-violet-400 bg-gray-900/50' : 'text-gray-300'}" style="top:${i*ROW_HEIGHT}px;height:${ROW_HEIGHT}px" onclick="playTrack(${i})">
                    <div class="overflow-hidden w-full">
                        <div class="font-medium text-sm truncate">${t.title}</div>
                        <div class="text-[10px] text-gray-500 truncate opacity-70">${t.path}</div>
                    </div>
                    ${i===currentTrackIdx ? '<i class="ph ph-speaker-high text-lg"></i>' : ''}
                </div>`;
            }
            content.innerHTML = html;
        }

        // 7. PLAYBACK & ARTWORK
        window.playTrack = async (i) => {
            currentTrackIdx = i;
            try {
                const f = await allTracks[i].handle.getFile();
                const url = URL.createObjectURL(f);
                audio.src = url;
                audio.play();
                
                // Update Basic UI
                document.getElementById('p-title').innerText = allTracks[i].title;
                document.getElementById('playIcon').className = "ph ph-pause-fill ml-0.5";
                renderList();
                
                // Reset Art
                document.getElementById('p-art').classList.add('hidden');
                document.getElementById('p-art-default').classList.remove('hidden');
                document.getElementById('p-artist').innerText = "Loading info...";

                // Lazy Load Metadata & Art
                window.jsmediatags.read(f, {
                    onSuccess: (tag) => {
                        const t = tag.tags;
                        if (t.artist) document.getElementById('p-artist').innerText = t.artist;
                        if (t.album) document.getElementById('status').innerText = t.album;
                        
                        // Extract Art
                        if (t.picture) {
                            const { data, format } = t.picture;
                            let base64String = "";
                            for (let i = 0; i < data.length; i++) base64String += String.fromCharCode(data[i]);
                            document.getElementById('p-art').src = `data:${format};base64,${window.btoa(base64String)}`;
                            document.getElementById('p-art').classList.remove('hidden');
                            document.getElementById('p-art-default').classList.add('hidden');
                            
                            // Media Session (Lock Screen Art)
                            if ('mediaSession' in navigator) {
                                navigator.mediaSession.metadata = new MediaMetadata({
                                    title: t.title || allTracks[i].title,
                                    artist: t.artist || "Unknown",
                                    artwork: [{ src: document.getElementById('p-art').src, sizes: '512x512', type: format }]
                                });
                            }
                        }
                    },
                    onError: () => document.getElementById('p-artist').innerText = "Unknown Artist"
                });

            } catch(e) { 
                log(e.message, 'error');
                if(e.name === 'NotAllowedError') document.getElementById('perm-banner').classList.remove('hidden');
            }
        };

        // 8. CONTROLS
        document.getElementById('playBtn').onclick = () => { audio.paused ? audio.play() : audio.pause(); updateIcon(); };
        const updateIcon = () => document.getElementById('playIcon').className = audio.paused ? "ph ph-play-fill ml-0.5" : "ph ph-pause-fill";
        audio.onplay = updateIcon; audio.onpause = updateIcon;
        audio.onended = () => { if(currentTrackIdx < allTracks.length-1) playTrack(currentTrackIdx+1); };
        audio.ontimeupdate = () => { if(audio.duration) document.getElementById('seek').value = (audio.currentTime/audio.duration)*100; };
        document.getElementById('seek').oninput = (e) => audio.currentTime = (e.target.value/100)*audio.duration;

        loadLibrary();
    </script>
</body>
</html>