<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Local PWA Player</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/regular/style.css">
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/fill/style.css">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
</head>
<body>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <!-- Back Button (Hidden by default) -->
            <button id="backBtn" class="btn-icon hidden">
                <i class="ph ph-arrow-left" style="color: #c4b5fd; font-weight: 700; font-size: 1.125rem;"></i>
            </button>

            <!-- Branding -->
            <div class="branding" id="header-branding">
                <div class="logo">
                    <i class="ph ph-music-notes"></i>
                </div>
                <div class="branding-text">
                    <h1>Local Stream</h1>
                    <p id="status">Ready</p>
                </div>
            </div>

            <!-- Album Title (Hidden by default) -->
            <h1 id="header-title" class="header-title hidden">Album View</h1>
        </div>

        <div class="header-right">
            <button id="themeBtn" class="btn-icon" title="Toggle theme">
                <i id="themeIcon" class="ph ph-moon"></i>
            </button>
            <button id="installBtn" class="btn btn-secondary hidden">
                <i class="ph ph-download-simple"></i>
            </button>
            <button id="scanBtn" class="btn btn-primary">
                <i class="ph ph-folder-notch-open"></i> Scan
            </button>
        </div>
    </header>

    <!-- Update Banner -->
    <div id="update-banner" class="perm-banner hidden" style="background: #10b981; cursor: pointer;">
        <i class="ph ph-arrow-clockwise"></i> Update available - Tap to refresh
    </div>

    <!-- Permission Banner -->
    <div id="perm-banner" class="perm-banner hidden">
        <i class="ph ph-key"></i> Tap here to restore SD Card Access
    </div>

    <!-- Main Content -->
    <main class="main">
        <!-- Album Grid View -->
        <div id="album-grid-container" class="album-grid hidden"></div>

        <!-- Track List View (Virtual Scroller) -->
        <div class="scroller-wrapper hidden" id="scroller-wrapper">
            <div id="scroller-container">
                <div id="scroller-phantom"></div>
                <div id="scroller-content"></div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="empty-state">
            <i class="ph ph-vinyl-record"></i>
            <p>Library Empty</p>
            <p class="hint">Tap "Scan" to index music</p>
        </div>

        <!-- Debug Logs -->
        <div class="log-panel" id="log-panel">
            <div class="log-header" onclick="toggleLogs()">
                <span>DEBUG LOGS</span><span onclick="event.stopPropagation(); document.getElementById('console-log').innerHTML=''">CLEAR</span>
            </div>
            <div id="console-log"></div>
        </div>
    </main>

    <!-- Player Controls -->
    <footer class="player">
        <div class="player-top">

            <!-- Art & Info -->
            <div class="player-info">
                <div class="player-art">
                    <img id="p-art" class="hidden">
                    <div id="p-art-default" class="player-art-default">
                        <i class="ph ph-music-note"></i>
                    </div>
                </div>
                <div class="player-details">
                    <h3 id="p-title" class="player-title">Not Playing</h3>
                    <p id="p-artist" class="player-artist">Select a track</p>
                </div>
            </div>

            <!-- Controls (Prev / Play / Next) -->
            <div class="player-controls">
                <button id="prevBtn" class="control-btn">
                    <i class="ph-fill ph-skip-back"></i>
                </button>

                <button id="playBtn" class="play-btn">
                    <i id="playIcon" class="ph-fill ph-play"></i>
                </button>

                <button id="nextBtn" class="control-btn">
                    <i class="ph-fill ph-skip-forward"></i>
                </button>
            </div>
        </div>

        <!-- Seek Bar -->
        <div class="seek-bar">
            <input type="range" id="seek" value="0" max="100">
        </div>
    </footer>

    <audio id="audio"></audio>

    <script>
        // --- 1. SYSTEM UTILS ---
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        const logPanel = document.getElementById('log-panel');

        // Register SW with update detection
        let updateWaiting = false;
        let registration = null;

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then((reg) => {
                    registration = reg;
                    console.log('[App] Service worker registered');

                    // Check for updates every 60 seconds
                    setInterval(() => {
                        reg.update();
                    }, 60000);

                    // Detect waiting service worker
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                updateWaiting = true;
                                showUpdateBanner();
                            }
                        });
                    });

                    // Handle controller change (new SW activated)
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (updateWaiting) {
                            window.location.reload();
                        }
                    });
                })
                .catch((err) => console.error('[App] SW registration failed:', err));
        }

        function showUpdateBanner() {
            const banner = document.getElementById('update-banner');
            banner.classList.remove('hidden');
            banner.onclick = () => {
                if (registration && registration.waiting) {
                    registration.waiting.postMessage('SKIP_WAITING');
                }
            };
        }

        // --- THEME MANAGEMENT ---
        const themeBtn = document.getElementById('themeBtn');
        const themeIcon = document.getElementById('themeIcon');
        const html = document.documentElement;

        // Load saved theme or default to dark
        const savedTheme = localStorage.getItem('theme') || 'dark';
        html.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        // Update meta theme-color based on theme
        function updateMetaTheme(theme) {
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            metaTheme.content = theme === 'dark' ? '#000000' : '#ffffff';
        }

        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.className = 'ph ph-moon';
            } else {
                themeIcon.className = 'ph ph-sun';
            }
            updateMetaTheme(theme);
        }

        themeBtn.onclick = () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        };

        // Install Prompt Logic
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden');
        });
        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return; deferredPrompt.prompt();
            await deferredPrompt.userChoice; deferredPrompt = null; installBtn.classList.add('hidden');
        });

        // Logger
        function log(msg, type = 'info') {
            const el = document.getElementById('console-log');
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            if (type === 'error') div.className = "error";
            el.appendChild(div);
        }
        function toggleLogs() {
            logPanel.classList.toggle('expanded');
        }

        // --- 2. DATABASE CONFIG ---
        const ROW_HEIGHT = 60;
        const BATCH_SIZE = 500;
        const db = new Dexie("MegaMusicPWA");
        // Schema includes 'album', 'path', and 'trackNumber'
        db.version(1).stores({ tracks: '++id, title, artist, path, album' });
        db.version(2).stores({ tracks: '++id, title, artist, path, album, trackNumber' }).upgrade(tx => {
            return tx.table("tracks").toCollection().modify(track => {
                if (!track.trackNumber) track.trackNumber = null;
            });
        });

        // --- 3. STATE MANAGEMENT ---
        let allTracks = [];
        let albums = {};     // Map: { "Album Name": [track1, track2...] }
        let albumKeys = [];  // Array: ["Album A", "Album B"]
        let albumCovers = {}; // Map: { "Album Name": "data:image/..." }

        // Navigation State
        let currentView = 'ALBUMS'; // 'ALBUMS' or 'TRACKS'
        let viewList = [];          // The actual array currently displayed
        let activeAlbumName = null;
        
        // Playback State
        let dirHandleRoot = null;
        let currentTrack = null;
        let playbackQueue = [];     // The list currently playing (for Next/Prev)
        let playbackIndex = -1;
        
        const audio = document.getElementById('audio');

        // --- 4. SCANNING (SD Card) ---
        document.getElementById('scanBtn').onclick = async () => {
            if (!window.showDirectoryPicker) return log("API Unsupported. Enable flags.", 'error');
            try {
                // Request Access
                dirHandleRoot = await window.showDirectoryPicker({ id: 'music_root', mode: 'read' });
                
                // Store Handle
                await db.tracks.put({ id: 'root_handle', handle: dirHandleRoot });
                await db.tracks.where('id').notEqual('root_handle').delete();
                
                const btn = document.getElementById('scanBtn');
                btn.innerText = "Scanning..."; btn.disabled = true;

                let buffer = [];
                let count = 0;

                async function traverse(handle, path) {
                    for await (const entry of handle.values()) {
                        if (entry.kind === 'file') {
                            const name = entry.name;
                            if (/\.(mp3|m4a|flac|wav|ogg)$/i.test(name)) {
                                // Use parent folder name as initial "Album"
                                const pathParts = path.split('/');
                                const folderName = pathParts[pathParts.length - 1] || "Unknown Album";

                                // Extract track number from filename (e.g., "01 - Song.mp3" -> 1)
                                const trackMatch = name.match(/^(\d+)/);
                                const trackNumber = trackMatch ? parseInt(trackMatch[1], 10) : null;

                                buffer.push({
                                    title: name, // Fallback: Filename
                                    handle: entry,
                                    path: path + "/" + name,
                                    album: folderName,
                                    artist: "Unknown Artist",
                                    trackNumber: trackNumber
                                });

                                if (buffer.length >= BATCH_SIZE) {
                                    await db.tracks.bulkAdd(buffer);
                                    count += buffer.length;
                                    document.getElementById('status').innerText = `Indexed ${count}`;
                                    buffer = [];
                                }
                            }
                        } else if (entry.kind === 'directory') {
                            await traverse(entry, path + "/" + entry.name);
                        }
                    }
                }

                log("Scan started...");
                await traverse(dirHandleRoot, "");
                if (buffer.length > 0) await db.tracks.bulkAdd(buffer);
                
                log("Scan complete.");
                btn.innerText = "Scan SD"; btn.disabled = false;
                loadLibrary();

            } catch (err) { 
                log(err.message, 'error'); 
                document.getElementById('scanBtn').disabled = false; 
            }
        };

        // --- 5. LOADING & GROUPING ---
        async function loadLibrary() {
            try {
                // Restore Handle
                const root = await db.tracks.get('root_handle');
                if (root) {
                    dirHandleRoot = root.handle;
                    // Check Perms
                    const perm = await dirHandleRoot.queryPermission({ mode: 'read' });
                    if (perm !== 'granted') document.getElementById('perm-banner').classList.remove('hidden');
                }
                
                // Load Tracks
                allTracks = await db.tracks.where('id').notEqual('root_handle').toArray();
                document.getElementById('status').innerText = `${allTracks.length} tracks`;
                
                if (allTracks.length > 0) {
                    document.getElementById('empty-state').classList.add('hidden');
                    groupAlbums();
                    switchView('ALBUMS');
                    // Extract album covers in background
                    extractAlbumCovers();
                }
            } catch(e) { log(e.message, 'error'); }
        }

        function groupAlbums() {
            albums = {};
            allTracks.forEach(t => {
                const alb = t.album || "Unknown";
                if (!albums[alb]) albums[alb] = [];
                albums[alb].push(t);
            });
            // Sort A-Z
            albumKeys = Object.keys(albums).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
        }

        // Render album grid
        function renderAlbumGrid() {
            const container = document.getElementById('album-grid-container');
            let html = '';

            albumKeys.forEach((albumName) => {
                const count = albums[albumName].length;
                const coverUrl = albumCovers[albumName];
                const escapedName = albumName.replace(/'/g, "\\'");

                html += `
                    <div class="album-card" onclick="switchView('TRACKS', '${escapedName}', true)">
                        <div class="album-cover">
                            ${coverUrl ? `<img src="${coverUrl}" alt="${albumName}">` : '<i class="ph ph-music-notes"></i>'}
                        </div>
                        <div class="album-info">
                            <div class="album-name">${albumName}</div>
                            <div class="album-track-count">${count} track${count !== 1 ? 's' : ''}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Extract album covers from first track of each album
        async function extractAlbumCovers() {
            for (const albumName of albumKeys) {
                if (albumCovers[albumName]) continue; // Skip if already cached

                const firstTrack = albums[albumName][0];
                if (!firstTrack || !firstTrack.handle) continue;

                try {
                    const file = await firstTrack.handle.getFile();
                    await new Promise((resolve) => {
                        window.jsmediatags.read(file, {
                            onSuccess: (tag) => {
                                if (tag.tags.picture) {
                                    const { data, format } = tag.tags.picture;
                                    let base64String = "";
                                    for (let i = 0; i < data.length; i++) {
                                        base64String += String.fromCharCode(data[i]);
                                    }
                                    albumCovers[albumName] = `data:${format};base64,${window.btoa(base64String)}`;
                                }
                                resolve();
                            },
                            onError: () => resolve()
                        });
                    });
                } catch (e) {
                    // Skip if file can't be read
                }
            }
            // Re-render albums with covers
            if (currentView === 'ALBUMS') renderAlbumGrid();
        }

        // --- 6. NAVIGATION VIEWS ---
        function switchView(mode, albumName = null, autoPlay = false) {
            currentView = mode;
            const backBtn = document.getElementById('backBtn');
            const branding = document.getElementById('header-branding');
            const titleEl = document.getElementById('header-title');
            const albumGrid = document.getElementById('album-grid-container');
            const scrollerWrapper = document.getElementById('scroller-wrapper');

            if (mode === 'ALBUMS') {
                viewList = albumKeys;
                activeAlbumName = null;

                backBtn.classList.add('hidden');
                branding.classList.remove('hidden');
                titleEl.classList.add('hidden');
                albumGrid.classList.remove('hidden');
                scrollerWrapper.classList.add('hidden');

                renderAlbumGrid();

            } else if (mode === 'TRACKS') {
                activeAlbumName = albumName;
                // Sort by track number, fallback to filename
                viewList = albums[albumName].sort((a,b) => {
                    // If both have track numbers, sort by track number
                    if (a.trackNumber != null && b.trackNumber != null) {
                        return a.trackNumber - b.trackNumber;
                    }
                    // If only one has track number, prioritize it
                    if (a.trackNumber != null) return -1;
                    if (b.trackNumber != null) return 1;
                    // Otherwise sort by path/filename
                    return a.path.localeCompare(b.path, undefined, {numeric: true});
                });

                backBtn.classList.remove('hidden');
                branding.classList.add('hidden');
                titleEl.innerText = albumName;
                titleEl.classList.remove('hidden');
                albumGrid.classList.add('hidden');
                scrollerWrapper.classList.remove('hidden');

                // Reset Scroll
                document.getElementById('scroller-container').scrollTop = 0;
                initScroller();

                // Auto-play first track if requested
                if (autoPlay && viewList.length > 0) {
                    setTimeout(() => playTrack(viewList[0].id), 100);
                }
            }
        }

        document.getElementById('backBtn').onclick = () => switchView('ALBUMS');
        document.getElementById('perm-banner').onclick = async () => {
            if(!dirHandleRoot) return;
            if ((await dirHandleRoot.requestPermission({ mode: 'read' })) === 'granted') {
                document.getElementById('perm-banner').classList.add('hidden');
            }
        };

        // --- 7. VIRTUAL SCROLLER RENDERER ---
        const container = document.getElementById('scroller-container');
        const content = document.getElementById('scroller-content');
        const phantom = document.getElementById('scroller-phantom');

        function initScroller() {
            phantom.style.height = `${viewList.length * ROW_HEIGHT}px`;
            container.onscroll = renderList;
            renderList();
        }

        function renderList() {
            const scrollTop = container.scrollTop;
            const viewportHeight = container.clientHeight;
            const start = Math.floor(scrollTop / ROW_HEIGHT);
            const end = Math.min(viewList.length - 1, start + Math.ceil(viewportHeight / ROW_HEIGHT) + 3);

            let html = '';
            for (let i = start; i <= end; i++) {
                const top = i * ROW_HEIGHT;

                // TRACK CARD
                const t = viewList[i];
                const isActive = currentTrack && currentTrack.id === t.id;
                html += `
                <div class="card ${isActive ? 'card-active' : ''}"
                     style="top:${top}px"
                     onclick="playTrack(${t.id})">
                    <div class="card-content" style="padding-right: 1rem;">
                        <div class="card-title">${t.title}</div>
                        <div class="card-meta">${t.artist}</div>
                    </div>
                    ${isActive ? '<i class="ph ph-speaker-high card-indicator"></i>' : ''}
                </div>`;
            }
            content.innerHTML = html;
        }

        // --- 8. PLAYBACK ENGINE ---
        window.playTrack = async (id) => {
            const track = allTracks.find(t => t.id === id);
            if (!track) return;

            // Update Queue: If we click a track, the current list becomes our playlist
            if (currentView === 'TRACKS') {
                playbackQueue = [...viewList];
                playbackIndex = playbackQueue.findIndex(t => t.id === id);
            }

            currentTrack = track;

            try {
                // Get File
                const f = await track.handle.getFile();
                audio.src = URL.createObjectURL(f);
                audio.play();

                // UI Update
                document.getElementById('p-title').innerText = track.title;
                document.getElementById('p-artist').innerText = track.artist;
                document.getElementById('playIcon').className = "ph-fill ph-pause";
                
                // Clear Art
                document.getElementById('p-art').classList.add('hidden');
                document.getElementById('p-art-default').classList.remove('hidden');
                
                renderList(); // Update highlights

                // METADATA UPDATE (Self-Healing)
                window.jsmediatags.read(f, {
                    onSuccess: async (tag) => {
                        const t = tag.tags;
                        let needsUpdate = false;

                        // Title
                        if (t.title && t.title !== track.title) {
                            track.title = t.title;
                            document.getElementById('p-title').innerText = t.title;
                            needsUpdate = true;
                        }

                        // Artist
                        if (t.artist && t.artist !== track.artist) {
                            track.artist = t.artist;
                            document.getElementById('p-artist').innerText = t.artist;
                            needsUpdate = true;
                        }

                        // Track Number
                        if (t.track && t.track !== track.trackNumber) {
                            const trackNum = typeof t.track === 'string' ? parseInt(t.track, 10) : t.track;
                            if (!isNaN(trackNum)) {
                                track.trackNumber = trackNum;
                                needsUpdate = true;
                            }
                        }

                        // Save to DB
                        if (needsUpdate) {
                            await db.tracks.update(track.id, {
                                title: track.title,
                                artist: track.artist,
                                trackNumber: track.trackNumber
                            });
                        }

                        // Artwork
                        if (t.picture) {
                            const { data, format } = t.picture;
                            let base64String = "";
                            for (let i = 0; i < data.length; i++) base64String += String.fromCharCode(data[i]);
                            const imgUrl = `data:${format};base64,${window.btoa(base64String)}`;
                            
                            const img = document.getElementById('p-art');
                            img.src = imgUrl;
                            img.classList.remove('hidden');
                            document.getElementById('p-art-default').classList.add('hidden');
                            
                            // Media Session
                            if ('mediaSession' in navigator) {
                                navigator.mediaSession.metadata = new MediaMetadata({
                                    title: track.title,
                                    artist: track.artist,
                                    album: track.album,
                                    artwork: [{ src: imgUrl, sizes: '512x512', type: format }]
                                });
                            }
                        }
                    },
                    onError: () => {}
                });

            } catch (e) {
                log(e.message, 'error');
                if (e.name === 'NotAllowedError') document.getElementById('perm-banner').classList.remove('hidden');
            }
        };

        // --- 9. CONTROLS ---
        function playNext() {
            if (playbackQueue.length === 0 || playbackIndex === -1) return;
            if (playbackIndex < playbackQueue.length - 1) {
                playTrack(playbackQueue[playbackIndex + 1].id);
            }
        }

        function playPrev() {
            if (playbackQueue.length === 0 || playbackIndex === -1) return;
            if (playbackIndex > 0) {
                playTrack(playbackQueue[playbackIndex - 1].id);
            }
        }

        document.getElementById('nextBtn').onclick = playNext;
        document.getElementById('prevBtn').onclick = playPrev;
        
        document.getElementById('playBtn').onclick = () => {
            if (audio.paused) {
                audio.play();
                document.getElementById('playIcon').className = "ph-fill ph-pause";
            } else {
                audio.pause();
                document.getElementById('playIcon').className = "ph-fill ph-play";
            }
        };

        // Audio Events
        audio.onplay = () => document.getElementById('playIcon').className = "ph-fill ph-pause";
        audio.onpause = () => document.getElementById('playIcon').className = "ph-fill ph-play";
        audio.onended = playNext;
        
        audio.ontimeupdate = () => {
            if(audio.duration) document.getElementById('seek').value = (audio.currentTime / audio.duration) * 100;
        };
        document.getElementById('seek').oninput = (e) => {
            if(audio.duration) audio.currentTime = (e.target.value / 100) * audio.duration;
        };

        // Media Session Actions
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', () => audio.play());
            navigator.mediaSession.setActionHandler('pause', () => audio.pause());
            navigator.mediaSession.setActionHandler('previoustrack', playPrev);
            navigator.mediaSession.setActionHandler('nexttrack', playNext);
        }

        // --- INIT ---
        loadLibrary();
    </script>
</body>
</html>